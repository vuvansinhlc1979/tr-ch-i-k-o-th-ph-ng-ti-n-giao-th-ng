<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game K√©o Th·∫£ Ph∆∞∆°ng Ti·ªán Giao Th√¥ng</title>
    <style>
        :root {
            --accent: #4caf50;
            --accent-dark: #388e3c;
            --panel-bg: #e6f9ee;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background: linear-gradient(#cfeefc, #ffffff 60%);
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        header {
            background: #ff9800;
            color: white;
            padding: 14px 10px;
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        /* CSS cho Game Info v√† Timer */
        #game-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 12px auto;
        }

        #score, #timer {
            background: var(--accent);
            color: white;
            padding: 8px 18px;
            border-radius: 12px;
            font-size: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            min-width: 150px; 
            text-align: center;
        }
        /* H·∫øt CSS m·ªõi */


        #game {
            flex: 1;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 24px;
            padding: 10px 30px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .drop-zone {
            width: 360px;
            height: 360px;
            border: 4px dashed var(--accent);
            border-radius: 18px;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 6px 14px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            box-sizing: border-box;
            transition: transform .18s ease, background .18s;
        }

        .drop-zone h3 {
            margin: 4px 0 10px;
            font-size: 20px;
            color: #0b3d2e;
            display:flex;
            align-items:center;
            gap:8px;
        }

        .drop-zone.correct { border-color: #00c853; background: #eaffea; }
        .drop-zone.wrong { border-color: #e53935; background: #ffecec; }

        .slot {
            flex: 1;
            width: 100%;
            display: grid;
            grid-auto-flow: row;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 6px;
            align-content: start;
            justify-items: center;
            padding: 6px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        #transports {
            display: flex;
            flex-wrap: nowrap;
            gap: 18px;
            justify-content: center;
            align-items: flex-end;
            padding: 18px;
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .transport {
            width: 120px;
            height: auto;
            cursor: grab;
            user-select: none;
            transition: transform .12s ease, filter 0.3s ease, opacity 0.3s ease;
        }

        .transport:active { cursor: grabbing; }

        .transport.disabled {
            filter: grayscale(100%);
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .slot img {
            width: 72px;
            height: 72px;
            object-fit: contain;
            border-radius: 6px;
        }

        /* CSS cho N√∫t G·ª≠i K·∫øt Qu·∫£ */
        #controls {
            background: #e8faf0;
            padding: 18px;
            box-shadow: 0 -4px 8px rgba(0,0,0,0.04);
            text-align: center;
            border-top: 2px solid var(--accent);
        }
        #submitBtn {
            padding: 12px 25px; 
            font-size: 18px; 
            cursor: pointer; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }
        #submitBtn:hover:not(:disabled) {
            background: var(--accent-dark);
        }
        #submitBtn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* H·∫øt CSS m·ªõi */
        
        footer {
            /* ·∫®n footer h∆∞·ªõng d·∫´n c≈© (kh√¥ng c·∫ßn n·ªØa) */
            display: none; 
        }

        @media (max-width: 1280px) {
            .drop-zone { width: 300px; height: 300px; }
        }

        @media (max-width: 900px) {
            .drop-zone { width: 48%; height: 300px; }
        }

        @media (max-width: 520px) {
            .drop-zone { width: 100%; height: 260px; }
            .transport { width: 90px; }
        }
    </style>
</head>

<body>
    <header>üéÆ K√âO TH·∫¢ PH∆Ø∆†NG TI·ªÜN GIAO TH√îNG üé®</header>
    <div id="game-info">
        <div id="score">ƒêi·ªÉm: 0</div>
        <div id="timer">Th·ªùi gian: 00:00</div>
    </div>

    <main id="game">
        <div class="drop-zone" data-type="duongkhong"><h3>‚úàÔ∏è ƒê∆∞·ªùng kh√¥ng</h3><div class="slot"></div></div>
        <div class="drop-zone" data-type="duongbo"><h3>üöó ƒê∆∞·ªùng b·ªô</h3><div class="slot"></div></div>
        <div class="drop-zone" data-type="duongthuy"><h3>üö¢ ƒê∆∞·ªùng th·ªßy</h3><div class="slot"></div></div>
        <div class="drop-zone" data-type="duongsat"><h3>üöÜ ƒê∆∞·ªùng s·∫Øt</h3><div class="slot"></div></div>
    </main>

    <div id="transports">
        <img src="may bay.png" class="transport" draggable="true" data-type="duongkhong" alt="M√°y bay">
        <img src="kinh khi cau.png" class="transport" draggable="true" data-type="duongkhong" alt="Khinh kh√≠ c·∫ßu">

        <img src="oto con.png" class="transport" draggable="true" data-type="duongbo" alt="√î t√¥">
        <img src="xe may.png" class="transport" draggable="true" data-type="duongbo" alt="Xe m√°y">
        <img src="xe dap.png" class="transport" draggable="true" data-type="duongbo" alt="Xe ƒë·∫°p">
        <img src="xe cuu hoa.png" class="transport" draggable="true" data-type="duongbo" alt="Xe c·ª©u h·ªèa">
        <img src="xe cuu thuong.png" class="transport" draggable="true" data-type="duongbo" alt="Xe c·ª©u th∆∞∆°ng">

        <img src="tau ngam.png" class="transport" draggable="true" data-type="duongthuy" alt="T√†u ng·∫ßm">
        <img src="tau thuy ok1.png" class="transport" draggable="true" data-type="duongthuy" alt="T√†u th·ªßy">
        <img src="thuyen buom.png" class="transport" draggable="true" data-type="duongthuy" alt="Thuy·ªÅn bu·ªìm">

        <img src="tau hoa.png" class="transport" draggable="true" data-type="duongsat" alt="T√†u h·ªèa">
        <img src="tau dien.png" class="transport" draggable="true" data-type="duongsat" alt="T√†u ƒëi·ªán">
    </div>

    <div id="controls">
        <button id="submitBtn">G·ª≠i K·∫øt Qu·∫£</button>
    </div>

    <audio id="correctSound" src="Dung.mp3"></audio>
    <audio id="wrongSound" src="Sai.mp3"></audio>

    <script>
    (function(){
        // üí° B∆Ø·ªöC QUAN TR·ªåNG: THAY TH·∫æ CHU·ªñI D∆Ø·ªöI ƒê√ÇY B·∫∞NG URL WEB APP C·ª¶A B·∫†N (L·∫§Y ·ªû b∆∞·ªõc tri·ªÉn khai Google Script)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx3wHQaNd1MrEMlUQGB6yrCFu8-Lc2RsWm7BrcU8n8OTkec5DgDJ8QODJWFev-DaeN9/exec'; 
        // V√ç D·ª§: const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx/exec';

        const transportsContainer = document.getElementById('transports');
        const transports = Array.from(document.querySelectorAll('.transport'));
        const zones = Array.from(document.querySelectorAll('.drop-zone'));
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const submitBtn = document.getElementById('submitBtn');
        const correctSound = document.getElementById('correctSound');
        const wrongSound = document.getElementById('wrongSound');
        
        let score = 0;
        const totalTransports = transports.length;
        
        let time = 0;
        let timerInterval;
        let completedItems = 0; 
        let isGameRunning = true; // C·ªù ki·ªÉm tra game c√≤n ƒëang ch·∫°y hay kh√¥ng

        // --- CH·ª®C NƒÇNG ƒê·ªíNG H·ªí & TH·ªúI GIAN ---

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const paddedMinutes = String(minutes).padStart(2, '0');
            const paddedSeconds = String(seconds).padStart(2, '0');
            return `${paddedMinutes}:${paddedSeconds}`;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                if (isGameRunning) {
                    time++;
                    timerEl.textContent = `Th·ªùi gian: ${formatTime(time)}`;
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isGameRunning = false;
        }

        // --- G·ª¨I D·ªÆ LI·ªÜU ƒê·∫æN GOOGLE SHEET ---

        async function sendResults() {
            stopTimer(); // ƒê·∫£m b·∫£o ƒë·ªìng h·ªì d·ª´ng
            
            const groupName = prompt(`üéâ Tr√≤ ch∆°i k·∫øt th√∫c! Vui l√≤ng nh·∫≠p T√™n Nh√≥m/T√™n b·∫°n (ƒêi·ªÉm: ${score}/${totalTransports}, Th·ªùi gian: ${formatTime(time)}):`);
            if (!groupName) {
                isGameRunning = true; // Cho ph√©p ch∆°i ti·∫øp n·∫øu h·ªßy
                startTimer();
                return;
            }

            const payload = {
                TenNhom: groupName,
                DiemSo: score, 
                ThoiGianChoiGiay: time 
            };

            submitBtn.disabled = true;
            submitBtn.textContent = '...ƒêang g·ª≠i k·∫øt qu·∫£...';

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.result === 'success') {
                    alert(`‚úÖ K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!`);
                    submitBtn.textContent = 'ƒê√É G·ª¨I XONG!';
                    submitBtn.style.background = '#388e3c'; 
                } else {
                    alert(`‚ùå L·ªói khi g·ª≠i k·∫øt qu·∫£ (Server b√°o l·ªói): ${result.message}`);
                    submitBtn.textContent = 'G·ª≠i L·ªói, Th·ª≠ L·∫°i';
                    submitBtn.disabled = false;
                    isGameRunning = true;
                    startTimer();
                }

            } catch (error) {
                console.error('L·ªói k·∫øt n·ªëi Google Script:', error);
                alert('‚ùå L·ªói k·∫øt n·ªëi Server. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c b√°o Gi√°o vi√™n.');
                submitBtn.textContent = 'G·ª≠i L·ªói, Th·ª≠ L·∫°i';
                submitBtn.disabled = false;
                isGameRunning = true;
                startTimer();
            }
        }
        
        function endGame() {
            // T·∫Øt k√©o th·∫£, d·ª´ng ƒë·ªìng h·ªì v√† g·ª≠i k·∫øt qu·∫£
            transports.forEach(t => t.draggable = false);
            sendResults(); 
        }
        
        // --- CH·ª®C NƒÇNG GAME G·ªêC (K√©o th·∫£, x√°o tr·ªôn) ---
        
        /**
         * H√†m x√°o tr·ªôn m·∫£ng (Thu·∫≠t to√°n Fisher-Yates)
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 1. üé≤ X√°o tr·ªôn th·ª© t·ª± c√°c h√¨nh ·∫£nh v√† ch√®n l·∫°i
        shuffleArray(transports);
        transports.forEach(img => {
            transportsContainer.appendChild(img);
        });
        
        // 2. ‚ú® C·∫≠p nh·∫≠t l·∫°i data-index v√† g·∫Øn l·∫°i c√°c s·ª± ki·ªán Drag
        transports.forEach((img, idx) => {
            img.dataset.index = idx;
            
            img.addEventListener('dragstart', (e) => {
                if (!isGameRunning || img.classList.contains('disabled') || img.dataset.placed === "true") {
                    e.preventDefault();
                    return;
                }
                e.dataTransfer.setData('text/plain', JSON.stringify({index: idx, type: img.dataset.type}));
                setTimeout(()=> img.classList.add('dragging'), 0);
            });
            img.addEventListener('dragend', ()=> img.classList.remove('dragging'));
        });

        // 3. üéØ X·ª≠ l√Ω s·ª± ki·ªán th·∫£
        zones.forEach(zone => {
            zone.addEventListener('dragover', e => e.preventDefault());
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!isGameRunning) return;

                const raw = e.dataTransfer.getData('text/plain');
                let payload = null;
                try { payload = JSON.parse(raw); } catch(err){ return; }
                if (!payload) return;
                const dragged = transports[payload.index];
                if (!dragged || dragged.dataset.placed === "true" || dragged.classList.contains('disabled')) return;

                if (payload.type === zone.dataset.type) {
                    // --- K√âO ƒê√öNG ---
                    const slot = zone.querySelector('.slot');
                    
                    // T·∫°o b·∫£n sao ·∫£nh ƒë√£ th·∫£ ƒë·ªÉ gi·ªØ ·∫£nh g·ªëc trong danh s√°ch transports
                    const placedImage = dragged.cloneNode(true);
                    placedImage.classList.remove('transport');
                    placedImage.style.width = '72px';
                    placedImage.style.height = '72px';
                    placedImage.draggable = false;
                    slot.appendChild(placedImage);
                    
                    dragged.style.display = 'none'; // ·∫®n ·∫£nh g·ªëc d∆∞·ªõi ch√¢n
                    dragged.dataset.placed = "true";
                    
                    score++;
                    completedItems++; 
                    scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
                    correctSound.play().catch(()=>{});

                } else {
                    // --- K√âO SAI ---
                    wrongSound.play().catch(()=>{});
                    zone.classList.add('wrong');
                    setTimeout(()=> zone.classList.remove('wrong'), 600);

                    // ‚ùå V√¥ hi·ªáu h√≥a ·∫£nh sai
                    dragged.classList.add('disabled');
                    dragged.draggable = false;
                    
                    completedItems++; 
                }
                
                // üèÅ KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN K·∫æT TH√öC GAME
                if (completedItems === totalTransports) {
                    endGame();
                }
            });
        });

        // --- B·∫ÆT ƒê·∫¶U GAME & S·ª∞ KI·ªÜN G·ª¨I K·∫æT QU·∫¢ ---
        
        startTimer(); // B·∫Øt ƒë·∫ßu ƒë·ªìng h·ªì ngay khi tr√≤ ch∆°i t·∫£i
        
        // G·∫Øn s·ª± ki·ªán g·ª≠i k·∫øt qu·∫£ cho n√∫t
        submitBtn.addEventListener('click', sendResults);

    })();
    </script>
</body>
</html>
